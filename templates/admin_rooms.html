{% extends "base.html" %}

{% block title %}Room Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">ÔøΩ Room Management</h2>
                    <p class="text-muted mb-0">Create new rooms and manage existing tournaments</p>
                </div>
                <div>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                        üìä Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats for Rooms -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>{{ rooms|length }}</h4>
                    <small>Total Rooms</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>{{ rooms|selectattr('14', 'equalto', 1)|list|length if rooms else 0 }}</h4>
                    <small>Active Rooms</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4>{{ rooms|selectattr('14', 'equalto', 0)|list|length if rooms else 0 }}</h4>
                    <small>Inactive Rooms</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>{{ rooms|selectattr('13', 'equalto', 1)|list|length if rooms else 0 }}</h4>
                    <small>Kill Rewards Enabled</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        
        <!-- Create New Room Form -->
        <div class="col-lg-4 mb-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">‚ûï Create New Room</h4>
                </div>
                <div class="card-body">
                <form method="POST" action="{{ url_for('create_room') }}">
                    <div class="mb-2">
                        <input type="text" name="room_name" class="form-control" placeholder="Room Name" required>
                    </div>
                    <div class="mb-2">
                        <select name="game_type" class="form-select" required>
                            <option value="">Select Game</option>
                            <option value="PUBG">PUBG</option>
                            <option value="FreeFire">FreeFire</option>
                            <option value="Call of Duty">Call of Duty</option>
                            <option value="Valorant">Valorant</option>
                        </select>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="number" name="entry_fee" class="form-control" placeholder="Entry Fee (coins)" required>
                        </div>
                        <div class="col-6">
                            <input type="number" name="prize_pool" class="form-control" placeholder="Prize Pool (Rs)" required>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-muted">Event Timing (Optional)</label>
                        <input type="datetime-local" name="event_timing" class="form-control">
                    </div>
                    <div class="row mb-2">
                        <div class="col-4">
                            <select name="is_multiplayer" class="form-select">
                                <option value="1">Multiplayer</option>
                                <option value="0">Single Player</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <input type="number" name="min_team_size" class="form-control" placeholder="Min Team Size" min="1" value="1">
                        </div>
                        <div class="col-4">
                            <input type="number" name="max_team_size" class="form-control" placeholder="Max Team Size" min="1" value="4">
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="number" name="max_players" class="form-control" placeholder="Max Total Players" required>
                        </div>
                        <div class="col-6">
                            <input type="number" name="min_players_to_start" class="form-control" placeholder="Min Players to Start" min="1" value="2">
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">üéØ Kill Reward System (Optional)</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_kill_rewards" name="enable_kill_rewards" value="1">
                                <label class="form-check-label" for="enable_kill_rewards">
                                    Enable Kill-based Rewards
                                </label>
                            </div>
                            <div class="row" id="kill_reward_settings" style="display: none;">
                                <div class="col-6">
                                    <input type="number" name="min_kills_required" class="form-control" placeholder="Minimum Kills Required" min="1" value="5">
                                    <small class="text-muted">Players need at least this many kills to get rewards</small>
                                </div>
                                <div class="col-6">
                                    <input type="number" step="0.01" name="reward_per_kill" class="form-control" placeholder="Reward per Kill (Rs)" min="0.01" value="10.00">
                                    <small class="text-muted">Amount in Rs per kill above minimum</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Winner Reward Configuration -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">üèÜ Winner Reward Configuration</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enable_custom_rewards" name="enable_custom_rewards" value="1">
                                <label class="form-check-label" for="enable_custom_rewards">
                                    Configure Custom Winner Rewards (otherwise auto-calculated from prize pool)
                                </label>
                            </div>
                            
                            <div id="custom_reward_settings" style="display: none;">
                                <!-- 1st Place Rewards -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-primary">ü•á 1st Place Rewards</h6>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Base Reward (Rs)</label>
                                        <input type="number" step="0.01" name="first_place_base_reward" class="form-control" placeholder="500.00" min="0" value="500.00">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Kill Bonus per Kill (Rs)</label>
                                        <input type="number" step="0.01" name="first_place_kill_bonus" class="form-control" placeholder="10.00" min="0" value="10.00">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Max Kill Bonus (Rs)</label>
                                        <input type="number" step="0.01" name="first_place_max_kill_bonus" class="form-control" placeholder="100.00" min="0" value="100.00">
                                    </div>
                                </div>

                                <!-- 2nd Place Rewards -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-success">ü•à 2nd Place Rewards</h6>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Base Reward (Rs)</label>
                                        <input type="number" step="0.01" name="second_place_base_reward" class="form-control" placeholder="300.00" min="0" value="300.00">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Kill Bonus per Kill (Rs)</label>
                                        <input type="number" step="0.01" name="second_place_kill_bonus" class="form-control" placeholder="7.50" min="0" value="7.50">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Max Kill Bonus (Rs)</label>
                                        <input type="number" step="0.01" name="second_place_max_kill_bonus" class="form-control" placeholder="75.00" min="0" value="75.00">
                                    </div>
                                </div>

                                <!-- 3rd Place Rewards -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h6 class="text-warning">ü•â 3rd Place Rewards</h6>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Base Reward (Rs)</label>
                                        <input type="number" step="0.01" name="third_place_base_reward" class="form-control" placeholder="200.00" min="0" value="200.00">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Kill Bonus per Kill (Rs)</label>
                                        <input type="number" step="0.01" name="third_place_kill_bonus" class="form-control" placeholder="5.00" min="0" value="5.00">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Max Kill Bonus (Rs)</label>
                                        <input type="number" step="0.01" name="third_place_max_kill_bonus" class="form-control" placeholder="50.00" min="0" value="50.00">
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <small>
                                        <strong>üí° How it works:</strong> Winners get Base Reward + (kills √ó Kill Bonus), capped at Max Kill Bonus.
                                        <br><strong>Example:</strong> 1st place with 15 kills = ‚Çπ500 + (15 √ó ‚Çπ10) = ‚Çπ650 (if under max limit)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Room Status Settings -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">‚öôÔ∏è Room Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Room Status</label>
                                    <select name="is_active" class="form-select">
                                        <option value="1" selected>Active (Users can join)</option>
                                        <option value="0">Inactive (Disabled)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">Pre-block Users (Optional)</label>
                                    <textarea name="blocked_users" class="form-control" rows="3" 
                                             placeholder="Enter usernames to block, one per line&#10;e.g.:&#10;username1&#10;username2"></textarea>
                                    <small class="text-muted">Users listed here will be blocked from joining this room</small>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Blocking Reason (Optional)</label>
                                    <textarea name="block_reason" class="form-control" rows="3" 
                                             placeholder="Reason for blocking users/teams..."></textarea>
                                    <small class="text-muted">This reason will be applied to all blocked users</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6">
                            <input type="text" name="room_id_game" class="form-control" placeholder="Game Room ID" required>
                        </div>
                        <div class="col-6">
                            <input type="text" name="room_password" class="form-control" placeholder="Room Password" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Create Room</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- All Rooms Table -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="card-title mb-0">üìã All Rooms</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Game</th>
                                <th>Entry Fee</th>
                                <th>Prize</th>
                                <th>Event Time</th>
                                <th>Mode</th>
                                <th>Team Size</th>
                                <th>Max Players</th>
                                <th>Room ID</th>
                                <th>Status</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for room in rooms %}
                            <tr>
                                <td><strong>{{ room[1] }}</strong></td>  <!-- room_name -->
                                <td><span class="badge bg-info">{{ room[2] }}</span></td>  <!-- game_type -->
                                <td>{{ room[3] }} üí∞</td>  <!-- entry_fee -->
                                <td>{{ room[4] }} Rs</td>  <!-- prize_pool -->
                                <td>
                                    {% if room[8] and room[8].__class__.__name__ == 'datetime' %}
                                        {{ room[8].strftime('%m/%d %H:%M') }}
                                    {% elif room[8] and room[8] != 'None' %}
                                        {{ room[8] }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>  <!-- event_timing -->
                                <td>{{ 'Multi' if room[9] else 'Single' }}</td>  <!-- is_multiplayer -->
                                <td>{{ room[10] }}-{{ room[11] }}</td>  <!-- min_team_size - max_team_size -->
                                <td>{{ room[5] }}</td>  <!-- max_players -->
                                <td><code>{{ room[6] }}</code></td>  <!-- room_id_game -->
                                <td>
                                    <span class="badge bg-{{ 'success' if room[12] == 'open' else 'secondary' }}">
                                        {{ room[12] }}
                                    </span>
                                </td>  <!-- status -->
                                <td>
                                    {% set is_active = room[14] if room|length > 14 else 1 %}
                                    <span class="badge bg-{{ 'success' if is_active else 'danger' }}">
                                        {{ 'Active' if is_active else 'Disabled' }}
                                    </span>
                                </td>  <!-- is_active -->
                                <td>
                                    <div class="btn-group-vertical" role="group">
                                        <!-- Room Toggle Button -->
                                        <form method="POST" action="{{ url_for('toggle_room', room_id=room[0]) }}" style="display: inline;">
                                            {% set is_active = room[14] if room|length > 14 else 1 %}
                                            <button type="submit" class="btn btn-sm btn-{{ 'warning' if is_active else 'success' }} mb-1">
                                                {{ 'Disable' if is_active else 'Enable' }} Room
                                            </button>
                                        </form>
                                        
                                        <!-- View Enrollments Button -->
                                        <a href="{{ url_for('room_enrollments', room_id=room[0]) }}" class="btn btn-sm btn-outline-info mb-1">
                                            üë• View Enrollments
                                        </a>
                                        
                                        <!-- Manage Kills Button -->
                                        {% if room|length > 13 and room[13] %}
                                        <a href="{{ url_for('manage_kills', room_id=room[0]) }}" class="btn btn-sm btn-warning mb-1">
                                            üéØ Manage Kills
                                        </a>
                                        {% endif %}
                                        
                                        <!-- Block User/Team Buttons -->
                                        <button class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal" data-bs-target="#blockUserModal" 
                                                onclick="setBlockUserRoom({{ room[0] }}, '{{ room[1] }}')">
                                            üö´ Block User
                                        </button>
                                        <button class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal" data-bs-target="#blockTeamModal" 
                                                onclick="setBlockTeamRoom({{ room[0] }}, '{{ room[1] }}')">
                                            üö´ Block Team
                                        </button>
                                        
                                        <!-- View Blocked List Button -->
                                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#viewBlockedModal" 
                                                onclick="viewBlockedUsers({{ room[0] }}, '{{ room[1] }}')">
                                            üìã View Blocked
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Blocked Users/Teams Modal -->
<div class="modal fade" id="viewBlockedModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìã Blocked Users & Teams</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Room: <span id="viewBlockedRoomName"></span></strong>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>üö´ Blocked Users</h6>
                        <div id="blockedUsersList" class="list-group">
                            <div class="text-center text-muted">Loading...</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>üö´ Blocked Teams</h6>
                        <div id="blockedTeamsList" class="list-group">
                            <div class="text-center text-muted">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Block User Modal -->
<div class="modal fade" id="blockUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="blockUserForm" method="POST" action="{{ url_for('block_user') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Block User from Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="room_id" id="blockUserRoomId">
                    <div class="mb-3">
                        <label class="form-label">Room: <span id="blockUserRoomName"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="blockUsername" class="form-label">Username to Block</label>
                        <input type="text" name="username" id="blockUsername" class="form-control" required autocomplete="off">
                        <datalist id="usernamesList">
                            <!-- Usernames will be loaded here -->
                        </datalist>
                        <small class="text-muted">Start typing to see username suggestions</small>
                    </div>
                    <div class="mb-3">
                        <label for="blockUserReason" class="form-label">Reason (Optional)</label>
                        <textarea name="reason" id="blockUserReason" class="form-control" rows="3" placeholder="Reason for blocking this user..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="unblockInstead" onchange="toggleUnblockMode()">
                            <label class="form-check-label" for="unblockInstead">
                                Unblock user instead
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="blockUserSubmit" class="btn btn-danger">Block User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Block Team Modal -->
<div class="modal fade" id="blockTeamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="blockTeamForm" method="POST" action="{{ url_for('block_team') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Block Team from Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="room_id" id="blockTeamRoomId">
                    <div class="mb-3">
                        <label class="form-label">Room: <span id="blockTeamRoomName"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="blockTeamSelect" class="form-label">Select Team to Block</label>
                        <select name="team_id" id="blockTeamSelect" class="form-control" required>
                            <option value="">Loading teams...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="blockTeamReason" class="form-label">Reason (Optional)</label>
                        <textarea name="reason" id="blockTeamReason" class="form-control" rows="3" placeholder="Reason for blocking this team..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="unblockTeamInstead" onchange="toggleTeamUnblockMode()">
                            <label class="form-check-label" for="unblockTeamInstead">
                                Unblock team instead
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" id="blockTeamSubmit" class="btn btn-danger">Block Team</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Block User Modal Functions
function setBlockUserRoom(roomId, roomName) {
    document.getElementById('blockUserRoomId').value = roomId;
    document.getElementById('blockUserRoomName').textContent = roomName;
    document.getElementById('blockUsername').value = '';
    document.getElementById('blockUserReason').value = '';
    document.getElementById('unblockInstead').checked = false;
    toggleUnblockMode();
    
    // Load usernames for auto-complete
    loadUsernameSuggestions();
}

function loadUsernameSuggestions() {
    const usernameInput = document.getElementById('blockUsername');
    const datalist = document.getElementById('usernamesList');
    
    // Clear existing options
    datalist.innerHTML = '';
    
    // Fetch usernames
    fetch('/api/users/suggestions')
        .then(response => response.json())
        .then(data => {
            if (data.usernames) {
                // Set up the datalist for auto-complete
                usernameInput.setAttribute('list', 'usernamesList');
                
                // Add all usernames to datalist
                data.usernames.forEach(username => {
                    const option = document.createElement('option');
                    option.value = username;
                    datalist.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading usernames:', error);
        });
}

function toggleUnblockMode() {
    const isUnblock = document.getElementById('unblockInstead').checked;
    const form = document.getElementById('blockUserForm');
    const submitBtn = document.getElementById('blockUserSubmit');
    const reasonField = document.getElementById('blockUserReason');
    
    if (isUnblock) {
        form.action = '{{ url_for("unblock_user") }}';
        submitBtn.textContent = 'Unblock User';
        submitBtn.className = 'btn btn-success';
        reasonField.style.display = 'none';
        reasonField.required = false;
    } else {
        form.action = '{{ url_for("block_user") }}';
        submitBtn.textContent = 'Block User';
        submitBtn.className = 'btn btn-danger';
        reasonField.style.display = 'block';
        reasonField.required = false;
    }
}

// Block Team Modal Functions
function setBlockTeamRoom(roomId, roomName) {
    document.getElementById('blockTeamRoomId').value = roomId;
    document.getElementById('blockTeamRoomName').textContent = roomName;
    document.getElementById('blockTeamReason').value = '';
    document.getElementById('unblockTeamInstead').checked = false;
    toggleTeamUnblockMode();
    loadTeamsForRoom(roomId);
}

function toggleTeamUnblockMode() {
    const isUnblock = document.getElementById('unblockTeamInstead').checked;
    const form = document.getElementById('blockTeamForm');
    const submitBtn = document.getElementById('blockTeamSubmit');
    const reasonField = document.getElementById('blockTeamReason');
    
    if (isUnblock) {
        form.action = '{{ url_for("unblock_team") }}';
        submitBtn.textContent = 'Unblock Team';
        submitBtn.className = 'btn btn-success';
        reasonField.style.display = 'none';
        reasonField.required = false;
    } else {
        form.action = '{{ url_for("block_team") }}';
        submitBtn.textContent = 'Block Team';
        submitBtn.className = 'btn btn-danger';
        reasonField.style.display = 'block';
        reasonField.required = false;
    }
}

function loadTeamsForRoom(roomId) {
    const select = document.getElementById('blockTeamSelect');
    select.innerHTML = '<option value="">Loading teams...</option>';
    
    // Fetch teams for this room
    fetch(`/api/room/${roomId}/teams`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            select.innerHTML = '<option value="">Select a team...</option>';
            
            if (data.teams.length === 0) {
                select.innerHTML = '<option value="">No teams available</option>';
                return;
            }
            
            data.teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                const enrollmentStatus = team.is_enrolled ? ' ‚úÖ Enrolled' : ' ‚è≥ Not Enrolled';
                option.textContent = `${team.name} (${team.leader})${enrollmentStatus}`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading teams:', error);
            select.innerHTML = '<option value="">Error loading teams</option>';
            
            // Show more detailed error in console for debugging
            console.error('Team loading failed:', {
                roomId: roomId,
                error: error.message,
                stack: error.stack
            });
        });
}

// View Blocked Users/Teams Modal Functions
function viewBlockedUsers(roomId, roomName) {
    document.getElementById('viewBlockedRoomName').textContent = roomName;
    
    // Show loading state
    document.getElementById('blockedUsersList').innerHTML = '<div class="text-center text-muted">Loading...</div>';
    document.getElementById('blockedTeamsList').innerHTML = '<div class="text-center text-muted">Loading...</div>';
    
    // Fetch blocked users and teams
    fetch(`/api/room/${roomId}/blocked_users`)
        .then(response => response.json())
        .then(data => {
            // Display blocked users
            const usersList = document.getElementById('blockedUsersList');
            if (data.blocked_users.length === 0) {
                usersList.innerHTML = '<div class="list-group-item text-muted">No blocked users</div>';
            } else {
                usersList.innerHTML = '';
                data.blocked_users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${user.username}</strong>
                                <br><small class="text-muted">${user.reason}</small>
                                <br><small class="text-muted">Blocked: ${user.blocked_at}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="quickUnblockUser('${user.username}', ${roomId})">
                                Unblock
                            </button>
                        </div>
                    `;
                    usersList.appendChild(item);
                });
            }
            
            // Display blocked teams
            const teamsList = document.getElementById('blockedTeamsList');
            if (data.blocked_teams.length === 0) {
                teamsList.innerHTML = '<div class="list-group-item text-muted">No blocked teams</div>';
            } else {
                teamsList.innerHTML = '';
                data.blocked_teams.forEach(team => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${team.team_name}</strong>
                                <br><small class="text-muted">${team.reason}</small>
                                <br><small class="text-muted">Blocked: ${team.blocked_at}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="quickUnblockTeam('${team.team_name}', ${roomId})">
                                Unblock
                            </button>
                        </div>
                    `;
                    teamsList.appendChild(item);
                });
            }
        })
        .catch(error => {
            console.error('Error loading blocked users/teams:', error);
            document.getElementById('blockedUsersList').innerHTML = '<div class="list-group-item text-danger">Error loading data</div>';
            document.getElementById('blockedTeamsList').innerHTML = '<div class="list-group-item text-danger">Error loading data</div>';
        });
}

// Quick unblock functions
function quickUnblockUser(username, roomId) {
    if (confirm(`Unblock user "${username}"?`)) {
        const form = new FormData();
        form.append('room_id', roomId);
        form.append('username', username);
        
        fetch('/admin/unblock_user', {
            method: 'POST',
            body: form
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Refresh page to show updated data
            } else {
                alert('Failed to unblock user');
            }
        })
        .catch(error => {
            console.error('Error unblocking user:', error);
            alert('Error unblocking user');
        });
    }
}

function quickUnblockTeam(teamName, roomId) {
    if (confirm(`Unblock team "${teamName}"?`)) {
        // You'd need to get the team ID here - for now, show message
        alert('Please use the "Block Team" modal to unblock teams (need team ID)');
    }
}

// Toggle kill reward settings
document.getElementById('enable_kill_rewards').addEventListener('change', function() {
    const settings = document.getElementById('kill_reward_settings');
    const inputs = settings.querySelectorAll('input');
    
    if (this.checked) {
        settings.style.display = 'flex';
        inputs.forEach(input => input.required = true);
    } else {
        settings.style.display = 'none';
        inputs.forEach(input => {
            input.required = false;
            input.value = input.placeholder.includes('Minimum') ? '5' : '10.00';
        });
    }
});

// Toggle custom winner reward settings
document.getElementById('enable_custom_rewards').addEventListener('change', function() {
    const settings = document.getElementById('custom_reward_settings');
    
    if (this.checked) {
        settings.style.display = 'block';
        // Auto-fill with percentage-based values from prize pool
        autoFillRewardValues();
    } else {
        settings.style.display = 'none';
    }
});

// Auto-fill reward values based on prize pool
function autoFillRewardValues() {
    const prizePoolInput = document.querySelector('input[name="prize_pool"]');
    if (!prizePoolInput || !prizePoolInput.value) return;
    
    const prizePool = parseFloat(prizePoolInput.value);
    
    // Auto-fill based on common tournament distributions (50%, 30%, 20%)
    document.querySelector('input[name="first_place_base_reward"]').value = (prizePool * 0.50).toFixed(2);
    document.querySelector('input[name="second_place_base_reward"]').value = (prizePool * 0.30).toFixed(2);
    document.querySelector('input[name="third_place_base_reward"]').value = (prizePool * 0.20).toFixed(2);
    
    // Set reasonable kill bonuses based on prize pool
    const firstKillBonus = Math.max(5, prizePool * 0.01).toFixed(2);
    const secondKillBonus = Math.max(3, prizePool * 0.0075).toFixed(2);
    const thirdKillBonus = Math.max(2, prizePool * 0.005).toFixed(2);
    
    document.querySelector('input[name="first_place_kill_bonus"]').value = firstKillBonus;
    document.querySelector('input[name="second_place_kill_bonus"]').value = secondKillBonus;
    document.querySelector('input[name="third_place_kill_bonus"]').value = thirdKillBonus;
    
    // Set max kill bonuses (20% of base reward)
    document.querySelector('input[name="first_place_max_kill_bonus"]').value = (prizePool * 0.50 * 0.20).toFixed(2);
    document.querySelector('input[name="second_place_max_kill_bonus"]').value = (prizePool * 0.30 * 0.20).toFixed(2);
    document.querySelector('input[name="third_place_max_kill_bonus"]').value = (prizePool * 0.20 * 0.20).toFixed(2);
}

// Auto-fill when prize pool changes
document.querySelector('input[name="prize_pool"]').addEventListener('input', function() {
    if (document.getElementById('enable_custom_rewards').checked) {
        autoFillRewardValues();
    }
});
</script>
{% endblock %}